\chapter{Architectural Design}
  
\section{Overview}
In the following paragraphs we'll present a general overview of how the system is architected, with specific focus on the distinction between logically separated layers.

Specifically, myTaxiService has been envisioned from the ground up to be fully scalable and easily deployable on any number of servers. This characteristic is not only desirable, but actually fundamental for the system to fully accomplish the tasks it's been designed for. In order to guarantee this level of flexibility and modularity, we have settled for a system architecture that inherently enables a wide range of hardware configurations for all kinds of workloads.

The system architecture is thus logically organized in a set of interplaying software layers, whose detailed description is hereby presented.

\begin{figure}[H]
\centering
\makebox[\columnwidth]{\includegraphics[width=350pt,keepaspectratio]{pdfs/overall_architecture.pdf}}
\end{figure}
\vspace{5mm}
The lowest layer of the architecture is composed by the relational \textbf{Data-base Management System (DBMS)} that supports all data storage operations. This component fully supports ACID distributed transactions and is meant to be run inside a Demilitarized Zone (DMZ) which is separated from the rest of the system for security reasons. (N.B. questo va messo qui?)
In order to provide a higher level of abstraction to all components that need access to data and to be as platform agnostic as possible, the DBMS interface is not directly exposed to the classes that implements the business logic of the system. Instead, an intermediate \textbf{Data Layer} is responsible of performing queries on the DBMS while exposing a more flexible, customized interface to the upper layers.

The \textbf{Business Layer} implements all core functionalities of the system. In particular, all operations related to handling taxi requests and reservations, taxi availability and zone management are performed by components of this layer. Data is stored and retrieved using the APIs exposed by the Data Layer. Core functionalities are exposed to clients through a unified Application Façade that allows fine-grained tuning of which operations can be invoked from outside the central system.

The Business Layer also depends on an external \textbf{Mapping Service} for the implementation of reverse geocoding and waiting time estimation operations. This external service is directly invoked by classes of the Business Layer by using a public API provided by the Mapping Service itself. 

However, not every functionality exposed by the Application Façade may actually be made publicly available to every client. In principle, several levels of permissions could be offered to third parties while maintaining control over private APIs which should only be used by "official clients". Read-only reporting functionalities, for example, could be made available to any requesting party, while more critical operations could be offered only to selected developers after having verified certain requirements are satisfied. Furthermore, specific sets of APIs could be made available only to approved plugins and not be offered to remote services. For this reason, the \textbf{Services Layer} provides a comprehensive interface to all kinds of third party services and plugins by carefully defining which methods are available for remote and local invocation, what protocols should be followed for invoking them and what kind of messages can be exchanged between a remote component and the central system.

While locally invokable APIs are made available only to plugins, remotely invokable APIs are also offered to components living outside the perimeter of the central system. The \textbf{Message Broker and Notification System} is precisely concerned with guaranteeing an efficient and reliable communication channel with these remote entities by supporting message queues, publish/subscribe communications and dynamic, asynchronous event notifications.

The \textbf{Web Presentation Layer} is responsible for the implementation of the web application. It generates the dynamic web pages, offers them to the client via a web server, accepts requests and forwards them to the business layer by means of the communication layer and of the services layer. 

Finally, the \textbf{Mobile Applications} let users access the functionalities offered by the system on their smartphones and tablets in a native way. As for the web application, they interact with the central system using the communication layer and the services layer.
  
\section{High level components and their interactions}
The purpose of this section is to present the main components in which myTaxiService is divided and the relations between them.

In particular, it should be noted that the components discussed here are very abstract clusters of functionalities which do not directly map to any specific module in the final system. Instead, they are intended as an useful representation to show how the main functionalities of the system are grouped together and interact with each other. Further details on how these components are realized in the actual system will be discussed with greater depth in the Component view subsection.

A schematic representation of the component structure of the system is the following.
\begin{figure}[H]
\centering
\makebox[\columnwidth]{\includegraphics[width=300pt,keepaspectratio]{pdfs/overall_components.pdf}}
\end{figure}

The \textbf{Account Management} component is responsible for all operations related to user accounts. More specifically:
	\begin{itemize}
		\item It implements the passenger registration process
		\item It implements the login procedure for all users 
		\item It supports operations on existing accounts, including settings management and password retrieval operations
	\end{itemize}

The \textbf{Taxi Management System} is the single most important component in the system. It is responsible for:
	\begin{itemize}
		\item Maintaining the availability status of each taxi updated
		\item Managing the taxi queue associated with each zone in the city
		\item Accepting and managing taxi reservations
		\item Fulfilling taxi requests by selecting the first available taxi in the corresponding taxi zone  
	\end{itemize}
	
The \textbf{System Administration} component offers system configuration and monitoring functionalities. It enables the insertion, update and deletion of taxis and taxi drivers and the definition of the boundaries of the zones in which the city is divided. It also lets administrators perform queries to obtain system statistics including uptime, number of served requests per day and other key performance indicators. The user interface for interacting with this component is provided by a web application. 

The \textbf{Database Management System (DBMS)} is the component responsible for storing and retrieving data in a persistent, reliable way. It should be noted that this component will not be implemented from scratch; instead, a commercial solution will be used.

The \textbf{Data Access Utilities} component provides an abstraction layer to all those components that need to store data into the DBMS or retrieve data from it.

The \textbf{Mapping Service} component is provided by a third party and is accessed via a publicly available API. It is used to perform reverse geocoding and to compute the ETA of the taxi assigned to a certain request.

The \textbf{Remote Services Interfaces} component provides external applications and clients a way to invoke the services offered by the central system. Specifically, it implements a platform-independent, SOAP-based web service which exposes the full set of remotely invokable methods defined by the public API specification of myTaxiService.

The \textbf{Notification System} component implements an event-based mechanism to notify remote applications and clients of specific changes in the status of the central system. In particular, this is employed to let users known when the system has assigned a taxi to their reservation.

As for how the system can be accessed by its users, the \textbf{Taxi Driver Application} and the \textbf{Passenger Application} provide a way for taxi drivers and passenger respectively to interact with the system through their smartphones, while the \textbf{Passenger Web Application} allows passengers perform their operations through a web browser. Finally, administrators can access the system using the aforementioned \textbf{Administration Web Application}.



\section{Component view}
In this section, we'll provide a more detailed description of the most significant components that must be developed as part of myTaxiService.

It should be noted that, when multiple operations or tasks are managed by a certain sub-component, not all of them will be explicitly mentioned in this section. This is because, at this level of detail, we want to put the focus on the primary goal of every sub-component; an exhaustive description of the functionalities implemented by each sub-component will be presented in the Requirements Traceability section of this document. 

The first component that we'll examine is the \textbf{Taxi Management System}. As we already mentioned, this component is primarily responsible for all operations related to taxi management. Although it may appear to be an atomic component, it is in fact composed of three different sub-components, each of them dedicated to handling a specific subset of operations:
	\begin{itemize}
		\item The \textbf{Reservation Management} sub-component performs all the activities related to reservation handling. In particular, it is able to receive a request for a new reservation, store it into an internal queue and periodically look for reservations that have come to expiration. Once such a reservation is found, it creates a request for it and transfers the computation to the Request Manager.
		\item The \textbf{Request Management} sub-component performs all the activities related to request handling. In particular, it is able to receive a new taxi request (either from an end user or from the reservation manager), retrieve the associated geographical coordinates through invocation of the Mapping Service API if the request only contains the meeting address, and use them to discover the zone from which the request is coming by invocation of an appropriate method of the Location Management sub-component. It then forwards the necessary information to the Taxi Management sub-component.
		\item The \textbf{Location Management} sub-component is essentially responsible for checking if the geographical coordinates of a certain place are inside the city and, if they are, it computes the zone they belong to. 
		\item The \textbf{Taxi Management} sub-component implements the methods to allocate a suitable taxi to a given request, keep the taxis' statuses updated and manage the zones' queues accordingly to the requirements which have been defined in the RASD.
	\end{itemize}
	
\begin{figure}[H]
\centering
\makebox[\columnwidth]{\includegraphics[width=300pt,keepaspectratio]{pdfs/taxi_mgmt_component.pdf}}
\end{figure}

The second component that we'll examine is the \textbf{Account Management} component. As we already mentioned, this component is primarily responsible for all operations related to user accounts handling. More specifically, this component is divided into four sub-components, each related to a different kind of operation:
	\begin{itemize}
		\item The \textbf{Passenger Registration} sub-component enables passengers to register to the taxi service and create their own account. In particular, it validates the required user data for formal consistency (i.e. checks that the date of birth, email address, mobile phone number and password are in valid format) and creates a temporary user account. It then sends a verification message containing a validation link to the specified email address and, upon user's confirmation, it enables the user account for full usage.
		\item The \textbf{Login} sub-component performs all necessary operations to let registered users log into the system. The user can be either a registered passenger, a taxi driver or a system administrator; depending on the user type, different login data may be required and a different level of privileges will be granted. 
		\item The \textbf{Password Retrieval} sub-components implements the password retrieval procedure for all registered users. Depending on the kind of user, a different recovery procedure may be followed.
		\item The \textbf{Settings Management} sub-component contains all the logic that is related to manipulation of an existing account by its owner. Depending on the kind of user, different options may be allowed.
	\end{itemize}

\begin{figure}[H]
\centering
\makebox[\columnwidth]{\includegraphics[width=300pt,keepaspectratio]{pdfs/account_management_component.pdf}}
\end{figure}

The third component that we'll examine is the \textbf{System Administration} component. As we already mentioned, this component is primarily responsible for all operations related to system configuration and monitoring functionalities. More specifically, this component is divided into five sub-components, each related to a different kind of operation:	
	\begin{itemize}
		\item The \textbf{API Permissions Management} sub-component give administrators fine-grained control over which APIs can be publicly accessed and what level of permissions is required to invoke them. More specifically, for each method exposed by the Remote Services Interface component it defines a visibility level that can be either "public" or "restricted". If the method is marked as "restricted", it also allows specifying a specific private key that must be held by the invoking application in order for the invocation to be successful. 
		\item The \textbf{Zone Division Management} sub-component implements all the methods for inserting and updating the zone division of the city. In particular, it allows insertion of new taxi zones and deletion or modification of existing ones. It also performs all the necessary checks to ensure that zone consistency is preserved: in particular, this means that overlapping zones won't be accepted. For security reasons, this component verifies that its methods are only invoked by a user with a sufficient level of privileges.
		\item The \textbf{Taxi Driver Management} sub-component implements all the methods for inserting and updating information about taxi drivers and the related taxis in the system. In particular, it allows insertion of new taxi drivers and taxis and deletion or modification of existing ones. It also performs all the necessary checks to ensure that information consistency is preserved. in particular, this includes validation of taxi driver licenses and taxi plates and enforces the one-to-one correspondence between a taxi driver and its taxi. For security reasons, this component verifies that its methods are only invoked by a user with a sufficient level of privileges.
		\item The \textbf{Service Statistics} sub-components is focused on offering a set of Key Performance Indicators (KPI) about the system operational status to all interested parties with sufficient privileges. This information can include uptime, number of served requests per day, average waiting time and other indicators. 
		\item The \textbf{Plugin Management} sub-component let administrators install, enable, disable and remove plugins. It also gives administrators a list of all permissions required by each plugin to work and allows them to selectively grant and revoke them.
	\end{itemize}
	
\begin{figure}[H]
\centering
\makebox[\columnwidth]{\includegraphics[width=300pt,keepaspectratio]{pdfs/sysadmin_component.pdf}}
\end{figure}
\pagebreak
\section{Deployment view}
The main purpose of this section is to show how the various components of the system are actually deployed on the hardware infrastructure.

The design of the hardware architecture was mostly influenced by these concerns: 
\begin{itemize}
	\item It had to be sufficiently reliable, available and scalable with respect to the non-functional requirements stated in the RASD
	\item It had to be compatible with the limited financial resources of a city administration 
	\item It had to be manageable by the city administration staff 
\end{itemize} 

For these reasons we have decided to avoid implementing a custom server farm specifically for this project. Instead, we have chosen to deploy myTaxiService on a third-party cloud infrastructure offered as a Platform as a Service.

The following diagram describes which are the most important devices and how software components are deployed on them.

It should be noted that, for readability reasons, we have explicitly depicted only a single instance of each hardware component despite the fact that they are actually arranged in replicated clusters. A load balancer is used to redistribute the workload across the instances.
\begin{landscape}
\includepdf[scale=0.95,angle=90]{pdfs/deployment.pdf}
\end{landscape}

\section{Runtime view}
The main purpose of this section is to show how the various components of the system interact with each other in some real world scenarios.

The first picture represents a snapshot of the system during its execution. In this scenario Alice is a passenger who has requested a taxi using the passenger mobile application installed on her smartphone, Bob is a taxi driver who has marked himself as available, Charles and Diana are two administrators that are performing queries on the system. The diagram clearly shows the set of processes and threads running on all the devices; in particular:
\begin{itemize}
	\item The Taxi Management Server is running a single Taxi Management System Process that is responsible of different threads, one for every kind of taxi-related operation. For example, the Request Manager thread is shown controlling a set of taxi requests, including Alice's; the Reservation Manager thread is shown controlling a set of taxi reservations; and the Taxi Manager Thread is shown managing the taxi queues of the different zones and the list of unavailable, out-of-city and currently riding taxis.
	\item The Account Manager Server is running a single Account Management process that contains a list of all active user accounts. In particular, in the picture it is shown containing Alice's, Bob's, Charles' and Diana's accounts.
	\item The System Administration Server is running a single System Administration process that is responsible of different threads, one for every administrative transaction operated on the system. Specifically, the picture shows the Statistics Evaluation thread invoked to satisfy Charles' query and the Taxi Drivers Management thread invoked to satisfy Diana's request.
	\item The Communication Services Server is running an instance of the Remote Services Interface servlet to expose the key functionalities of the system to remote clients and an instance of the Notification System.
	\item The Web Application Servers are running instances of the Passenger Web Application presentation logic and of the Administration Web Application presentation logic.
	\item The Load Balancing nodes are running instances of the Apache Web Server to redirect HTTP requests to different instances of the business logic nodes.
\end{itemize}

The next pictures in this section depict the flow of events (in particular method invocations) for the most important operations in the form of sequence diagrams. 
\begin{landscape}
\includepdf[scale=0.95,angle=90]{pdfs/runtime.pdf}
\end{landscape}


\section{Component interfaces}

\section{Selected architectural styles and patterns}
SOA
Layered Architecture
N-tier
Publish/Subscribe (for notifications)


\section{Other design decisions}